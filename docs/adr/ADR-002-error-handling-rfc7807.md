# ADR-002: Обработка ошибок в формате RFC 7807

**Статус:** Accepted
**Дата:** 21.10.2025
**Автор:** @Gruz2520

## Context

Текущая система обработки ошибок в WishList API использует простой формат JSON с полями `error.code` и `error.message`. Это не соответствует стандартам безопасности и не обеспечивает:

- Единообразный формат ошибок согласно RFC 7807
- Маскирование чувствительной информации (PII)
- Корреляционные ID для трассировки
- Структурированную информацию об ошибках
- Связь с HTTP статус кодами

## Decision

Реализовать обработку ошибок в соответствии с RFC 7807 "Problem Details for HTTP APIs" со следующими компонентами:

### 1. Стандартный формат ошибок RFC 7807
```json
{
  "type": "https://api.wishlist.com/errors/validation-error",
  "title": "Validation Error",
  "status": 400,
  "detail": "The request contains invalid data",
  "instance": "/wishlist/items",
  "correlation_id": "req-123456789"
}
```

### 2. Маскирование PII данных
- Автоматическое обнаружение и маскирование email адресов
- Маскирование токенов и паролей
- Сокрытие внутренних путей и конфигурации
- Логирование полной информации отдельно от пользовательского ответа

### 3. Корреляционные ID
- Генерация уникального correlation_id для каждого запроса
- Передача correlation_id в заголовках ответа
- Включение correlation_id во все логи
- Поддержка передачи correlation_id от клиента

### 4. Категоризация ошибок
- **validation-error**: Ошибки валидации входных данных
- **not-found**: Ресурс не найден
- **authentication-error**: Ошибки аутентификации
- **authorization-error**: Ошибки авторизации
- **rate-limit-error**: Превышение лимитов запросов
- **internal-error**: Внутренние ошибки сервера

## Alternatives

### Альтернатива 1: Сохранение текущего формата
**Плюсы:**
- Простота реализации
- Обратная совместимость

**Минусы:**
- Не соответствует стандартам
- Отсутствие маскирования PII
- Нет трассировки запросов
- Плохая интеграция с мониторингом


### Security Impact
- **Снижение рисков:** R02, R06
- **Соответствие NFR:** NFR-02, NFR-10
- **STRIDE покрытие:** Information Disclosure, Tampering

## Rollout Plan

### Этап 1: Реализация базового формата
- Создать классы для RFC 7807 ошибок
- Реализовать маскирование PII
- Добавить генерацию correlation_id

### Этап 2: Интеграция с FastAPI
- Обновить exception handlers
- Добавить middleware для correlation_id
- Реализовать логирование с маскированием

### Этап 3: Тестирование и документация
- Создать тесты для всех типов ошибок
- Обновить API документацию
- Провести security review

### Этап 4: Мониторинг и алерты
- Настроить метрики ошибок
- Создать дашборды для мониторинга
- Настроить алерты на критические ошибки

## Links

- **NFR:** NFR-02, NFR-10
- **Threat Model:** F6, F1
- **Риски:** R02, R06
- **Тесты:** `tests/test_error_handling.py`
- **Код:** `app/security/error_handling.py`
- **RFC 7807:** https://tools.ietf.org/html/rfc7807

# ADR-001: Валидация ввода и загрузок

**Статус:** Accepted
**Дата:** 21.10.2025
**Автор:** @Gruz2520

## Context

В рамках проекта WishList API необходимо обеспечить безопасную обработку пользовательского ввода и загрузок файлов. Текущая реализация использует базовую валидацию Pydantic, но не покрывает все аспекты безопасности, включая:

- Проверку magic bytes для загружаемых файлов
- Ограничения размера и времени загрузки
- Канонизацию путей и защиту от directory traversal
- Запрет символических ссылок
- Использование UUID для имен файлов

## Decision

Реализовать комплексную систему валидации ввода с использованием следующих компонентов:

### 1. Валидация загружаемых файлов
- Проверка magic bytes для определения реального типа файла
- Ограничение размера файла до 10MB
- Таймаут загрузки 30 секунд
- Поддержка только безопасных типов: image/jpeg, image/png, application/pdf

### 2. Защита от path traversal
- Канонизация всех путей
- Проверка, что итоговый путь находится в разрешенной директории
- Запрет символических ссылок

### 3. Безопасные имена файлов
- Генерация UUID для всех загружаемых файлов
- Удаление специальных символов из оригинальных имен
- Сохранение расширения файла для удобства

### 4. Валидация входных данных
- Строгая валидация всех строковых полей
- Проверка на SQL-инъекции и XSS
- Ограничение длины полей

## Alternatives

### Альтернатива 1: Использование только Pydantic валидации
**Плюсы:**
- Простота реализации
- Интеграция с FastAPI

**Минусы:**
- Недостаточная защита от file upload атак
- Отсутствие проверки magic bytes
- Нет защиты от path traversal


## Consequences

### Положительные последствия
- Повышение безопасности приложения
- Защита от file upload атак
- Соответствие требованиям NFR-02 (формат ошибок)
- Снижение риска R06 (нет маскирования ошибок)

### Негативные последствия
- Увеличение сложности кода
- Дополнительные проверки производительности
- Необходимость тестирования edge cases

### Security Impact
- **Снижение рисков:** R06, R11
- **Соответствие NFR:** NFR-02, NFR-10
- **STRIDE покрытие:** Spoofing, Tampering, Information Disclosure

## Rollout Plan

### Этап 1: Реализация базового минимума
- Добавить валидацию magic bytes
- Реализовать ограничения размера файла
- Создать утилиты для безопасной работы с путями

### Этап 2: Интеграция с API
- Обновить эндпойнты для использования новой валидации
- Добавить обработку ошибок в формате RFC 7807
- Реализовать логирование с correlation_id

### Этап 3: Тестирование и мониторинг
- Создать unit и integration тесты
- Настроить мониторинг метрик валидации
- Провести security review

## Links

- **NFR:** NFR-02, NFR-10
- **Threat Model:** F5, F6
- **Риски:** R06, R11
- **Тесты:** `tests/test_input_validation.py`
- **Код:** `app/security/validation.py`

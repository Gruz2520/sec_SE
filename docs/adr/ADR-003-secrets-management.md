# ADR-003: Управление секретами

**Статус:** Accepted
**Дата:** 21.10.2025
**Автор:** @Gruz2520

## Context

В рамках проекта WishList API необходимо обеспечить безопасное управление секретами, включая:

- Хранение и ротацию секретов
- Защиту от утечек в коде и логах
- Централизованное управление конфигурацией
- Безопасную передачу секретов между сервисами

Текущая реализация не имеет системы управления секретами, что создает риски:
- R07: Секреты в git (Risk: 25)
- R02: Утечка PII в логах (Risk: 20)
- Отсутствие ротации секретов
- Нет защиты от случайных коммитов секретов

## Decision

Реализовать комплексную систему управления секретами с использованием следующих компонентов:

### 1. Централизованное хранение секретов
- Использование переменных окружения для всех секретов
- Поддержка .env файлов для локальной разработки
- Интеграция с внешними системами (Vault, AWS Secrets Manager)
- Запрет хранения секретов в коде и конфигурационных файлах

### 2. Ротация секретов
- Автоматическая ротация каждые 30 дней
- Уведомления о необходимости ротации
- Поддержка graceful переключения между версиями
- Аудит использования секретов

### 3. Защита от утечек
- Pre-commit hooks для сканирования секретов
- Регулярное сканирование репозитория
- Маскирование секретов в логах
- Валидация конфигурации при запуске

### 4. Безопасная передача
- Использование HTTPS для всех внешних соединений
- Шифрование секретов в транзите
- Валидация TLS сертификатов
- Поддержка mTLS для сервис-сервис коммуникации

## Alternatives

### Альтернатива 1: Хранение секретов в коде
**Плюсы:**
- Простота разработки
- Нет дополнительных зависимостей

**Минусы:**
- Высокий риск утечек
- Невозможность ротации
- Нарушение принципов безопасности
- Несоответствие NFR-08

## Consequences

### Положительные последствия
- Соответствие NFR-08 (ротация и хранение секретов)
- Снижение рисков R07 (секреты в git) и R02 (утечка PII)
- Улучшенная безопасность приложения
- Лучший аудит и мониторинг
- Соответствие требованиям compliance

### Негативные последствия
- Увеличение сложности развертывания
- Необходимость обучения команды
- Дополнительные инструменты и процессы
- Потенциальные проблемы с локальной разработкой

### Security Impact
- **Снижение рисков:** R07 (секреты в git), R02 (утечка PII в логах)
- **Соответствие NFR:** NFR-08 (ротация и хранение секретов)
- **STRIDE покрытие:** Information Disclosure, Tampering, Spoofing

## Rollout Plan

### Этап 1: Базовая защита
- Настроить pre-commit hooks для сканирования секретов
- Реализовать маскирование секретов в логах
- Создать валидацию конфигурации

### Этап 2: Централизованное управление
- Интегрировать с системой управления секретами
- Реализовать ротацию секретов
- Настроить мониторинг использования

### Этап 3: Автоматизация и мониторинг
- Настроить автоматическую ротацию
- Создать дашборды для мониторинга
- Настроить алерты на подозрительную активность

### Этап 4: Аудит и compliance
- Реализовать аудит доступа к секретам
- Создать отчеты для compliance
- Настроить автоматические проверки безопасности

## Security Controls

### Детекция секретов
- Регулярные выражения для поиска API ключей
- Проверка на пароли и токены
- Сканирование конфигурационных файлов
- Анализ истории git

### Защита в runtime
- Маскирование секретов в логах
- Валидация TLS соединений
- Шифрование секретов в памяти
- Очистка памяти после использования

### Мониторинг и алерты
- Отслеживание доступа к секретам
- Алерты на подозрительную активность
- Аудит изменений конфигурации
- Отчеты о нарушениях политик

## Links

- **NFR:** NFR-08 (ротация и хранение секретов)
- **Threat Model:** Auth Service, F3 (JWT AuthZ)
- **Риски:** R07 (секреты в git), R02 (утечка PII в логах)
- **Тесты:** `tests/test_secrets_management.py`
- **Код:** `app/security/secrets.py`
- **Конфигурация:** `.env.example`, `docker-compose.override.yml`
